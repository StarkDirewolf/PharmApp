Finds details of items that have come back but request is still showing as requested
SELECT P.GivenName, P.Surname, P.PatientId, Prep.PreparationCodeId, Prep.ApprovedName ,R.DateAdded, O.Name, Pack.*, Recent.* FROM ProScriptConnect.RMS.RequestItem I
JOIN ProScriptConnect.RMS.Request R ON I.RequestId = R.RequestId
JOIN ProScriptConnect.dbo.Patient P ON R.PatientId = P.PatientId
JOIN ProScriptConnect.dbo.PrescribingOrganisation O ON O.PrescribingOrganisationId = R.PrescribingOrganisationId
JOIN PKBRuntime.Pharmacy.Preparation Prep ON Prep.PreparationCodeId = I.PreparationCodeId
JOIN ProScriptConnect.PTS.PrescriptionTracking Pt ON Pt.PrescriptionTrackingId = R.PrescriptionTrackingId

OUTER APPLY (SELECT TOP 1 Pack2.Gncs FROM PKBRuntime.Pharmacy.PreparationPack Pack2 WHERE I.PreparationCodeId = Pack2.PreparationCodeId) AS Pack

OUTER APPLY (
	SELECT Dates.MostRecentDate, Pack2.Gncs, Prep2.ApprovedName FROM (
	SELECT MAX(Pre.AddedDate) AS MostRecentDate, I.PreparationCodeId FROM ProScriptConnect.PMR.PrescriptionItem I
	JOIN ProScriptConnect.PMR.Prescription Pre ON I.PrescriptionId = Pre.PrescriptionId
	WHERE Pre.PatientId = P.PatientId
	GROUP BY I.PreparationCodeId) AS Dates

	JOIN PKBRuntime.Pharmacy.Preparation Prep2 ON Dates.PreparationCodeId = Prep2.PreparationCodeId
	OUTER APPLY (SELECT TOP 1 Pack3.Gncs FROM PKBRuntime.Pharmacy.PreparationPack Pack3 WHERE Dates.PreparationCodeId = Pack3.PreparationCodeId) AS Pack2
	WHERE Pack2.Gncs = Pack.Gncs
) AS Recent

WHERE R.DateAdded < Recent.MostRecentDate AND R.Deleted = 0 AND Pt.PrescriptionTrackingStatusTypeId = 3 AND P.DateOfDeath IS NULL
ORDER BY R.DateAdded ASC

Updating needs following
PTS - Statustypeid -> 10
trackingcompletiontypeid -> 1
collectionpatientid -> patiendid
relationtopatientid -> 21

RequestItem -> trackingID -> requests' trackingid






SELECT * FROM ProScriptConnect.RMS.Request R
JOIN ProScriptConnect.PTS.PrescriptionTracking T ON T.PrescriptionTrackingId = R.PrescriptionTrackingId


SELECT * FROM ProScriptConnect.PTS.PrescriptionTrackingStatusType


finding surgery code
SELECT DISTINCT PrescribingOrganisationId, PrescribingOrganisationName FROM ProScriptConnect.RMS.RequestSummaryView
WHERE PrescribingOrganisationName LIKE '%Bower%'



summary view filter out deleted and by surgery and status(?)
SELECT * FROM ProScriptConnect.RMS.RequestSummaryView R 
WHERE Deleted = 0 AND PrescribingOrganisationId = 190 AND
ORDER BY RequestDateAdded


RMS recent requested that arent back yet
SELECT DISTINCT P.GivenName, P.Surname, P.PatientId, Prep.PreparationCodeId, Prep.ApprovedName ,R.DateAdded, O.Name FROM ProScriptConnect.RMS.RequestItem I
JOIN ProScriptConnect.RMS.Request R ON I.RequestId = R.RequestId
JOIN ProScriptConnect.dbo.Patient P ON R.PatientId = P.PatientId
JOIN ProScriptConnect.dbo.PrescribingOrganisation O ON O.PrescribingOrganisationId = R.PrescribingOrganisationId
JOIN PKBRuntime.Pharmacy.Preparation Prep ON Prep.PreparationCodeId = I.PreparationCodeId
JOIN ProScriptConnect.PTS.PrescriptionTracking Pt ON Pt.PrescriptionTrackingId = R.PrescriptionTrackingId
WHERE R.DateAdded > '2021-01-01' AND R.Deleted = 0 AND Pt.PrescriptionTrackingStatusTypeId = 3 AND P.DateOfDeath IS NULL
ORDER BY R.DateAdded ASC




PMR history with most recent had items but lists all brands - need to show only brand they had
SELECT DISTINCT P.MostRecentDate, Prep.ApprovedName FROM (SELECT MAX(Presc.AddedDate) AS MostRecentDate, Pa.Gncs
FROM ProScriptConnect.PMR.PrescriptionItem Pitem
JOIN ProScriptConnect.PMR.Prescription Presc ON Presc.PrescriptionId = Pitem.PrescriptionId
JOIN PKBRuntime.Pharmacy.PreparationPack Pa ON Pa.PreparationCodeId = Pitem.PreparationCodeId
WHERE Presc.PatientId = 38561
GROUP BY Pa.Gncs) AS P
JOIN PKBRuntime.Pharmacy.PreparationPack PrepPack ON P.Gncs = PrepPack.Gncs
JOIN PKBRuntime.Pharmacy.Preparation Prep ON Prep.PreparationCodeId = PrepPack.PreparationCodeId
ORDER BY P.MostRecentDate DESC